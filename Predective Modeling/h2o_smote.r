setwd("P:/2019 0970 151 000/User Data/Faraz-Export IDAVE folders/Models2.5")
library(tidyverse)
library(h2o)
h2o.init()
##########Smote data 

smote_train <- readRDS("../smote_data/smote_train.rds")
smote_test <- readRDS("../smote_data/test.rds")

str(smote_train)
# .frame':   1973985 obs. of  41 variables:
 # $ acutelos          : num  16 9 7 2 2 3 2 3 13 1 ...
 # $ main_PhysInj_1L   : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 1 1 ...
 # $ patserv_34        : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 2 1 ...
 # $ admambul          : Factor w/ 2 levels "N","Y": 2 1 2 2 2 2 2 2 2 1 ...
 # $ dementia_main     : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 1 1 ...
 # $ all_Cachx_3L      : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 1 1 ...
 # $ weightloss        : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 1 1 ...
 # $ cacsitcnt         : num  2 0 1 1 2 3 0 2 2 0 ...
 # $ main_MentBehav_1L : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 1 1 ...
 # $ age_grp           : Factor w/ 4 levels "1","2","3","4": 1 2 2 4 4 1 1 4 4 1 ...
 # $ frail_grp         : Factor w/ 2 levels "high","low": 2 2 2 2 2 2 2 2 1 2 ...
 # $ flag_feeding_tb   : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 1 1 ...
 # $ patserv_12        : Factor w/ 2 levels "0","1": 2 1 1 1 1 1 1 1 1 1 ...
 # $ patserv_38        : Factor w/ 2 levels "0","1": 1 1 2 1 1 1 1 1 1 1 ...
 # $ main_Zfactors_1L  : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 2 1 1 1 ...
 # $ prv_orthop        : Factor w/ 2 levels "No","Yes": 1 1 1 1 1 1 1 1 1 1 ...
 # $ dementia_comorb   : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 1 1 ...
 # $ patserv_17        : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 2 1 1 ...
 # $ cacsit1_grp3      : Factor w/ 5 levels "Cat_scan","Notapp",..: 1 2 1 5 4 1 2 1 5 2 ...
 # $ patserv_15        : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 1 2 ...
 # $ main_MusclSkelt_1L: Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 2 1 ...
 # $ flag_tracheost    : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 1 1 ...
 # $ rural             : Factor w/ 2 levels "N","Y": 1 2 1 2 1 1 2 1 1 1 ...
 # $ triage            : Factor w/ 6 levels "1","2","3","4",..: 2 3 3 2 3 1 3 2 2 3 ...
 # $ cacsitcnt1        : Factor w/ 3 levels "Notapp","Just1",..: 2 1 2 2 2 2 1 2 3 1 ...
 # $ patserv_72        : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 1 1 ...
 # $ patserv_39        : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 1 1 ...
 # $ flag_radiother    : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 1 1 ...
 # $ scu               : Factor w/ 16 levels "10","20","25",..: 16 16 16 16 16 7 16 16 4 16 ...
 # $ flag_vasc_accdv   : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 1 1 ...
 # $ flag_mvent_ge96   : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 1 1 ...
 # $ female_flag       : Factor w/ 2 levels "0","1": 2 1 1 2 2 1 2 2 2 2 ...
 # $ prv_grp           : Factor w/ 3 levels "1","3","oth": 2 1 2 1 2 2 1 2 2 1 ...
 # $ psychoses         : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 1 1 ...
 # $ readm_90d         : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 2 1 ...
 # $ flag_pa_nutrit    : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 1 1 ...
 # $ paralysis         : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 1 1 ...
 # $ patserv_36        : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 1 1 ...
 # $ patserv_64        : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 1 1 ...
 # $ flag_cardiovers   : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 1 1 ...
 # $ alc_status        : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 1 1 ...'

train_hex <- as.h2o(smote_train)
test_hex <- as.h2o(smote_test)

df_rf1 <- h2o.randomForest(
training_frame = train_hex,
# validation_frame = test_hex,
x = 1:40,
y = ncol(smote_train),
model_id = "rf_smote",
nfolds = 5,
fold_assignment = "Stratified",
# balance_classes = TRUE,
ntrees = 500,
stopping_rounds = 5,
stopping_tolerance = 1e-3, ##early stop if AUCPR did not improve at least 0.1% over 5 consecutive turns
stopping_metric = "AUCPR",
score_tree_interval = 5,
score_each_iteration = T,
seed = 1234
)

perf <- h2o.performance(df_rf1, newdata = test_hex)

##Does not work well on test data, overfits on training despite cross validation etc
